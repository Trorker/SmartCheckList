<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196f3">

    <title>Check List Cantieri - Levratti</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚧</text></svg>">

    <!-- BeerCSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.js"></script>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- animate.css -->
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />-->

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Dexie.js -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <!-- jsPDF -->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


    <style>
        /* Tema personalizzato chiaro e scuro */
        :root {
            --primary: #006e1c;
            --on-primary: #ffffff;
            --primary-container: #94f990;
            --on-primary-container: #002204;
            --secondary: #52634f;
            --on-secondary: #ffffff;
            --secondary-container: #d5e8cf;
            --on-secondary-container: #111f0f;
            --tertiary: #38656a;
            --on-tertiary: #ffffff;
            --tertiary-container: #bcebf0;
            --on-tertiary-container: #002023;
            --error: #ba1a1a;
            --on-error: #ffffff;
            --error-container: #ffdad6;
            --on-error-container: #410002;
            --background: #fcfdf6;
            --on-background: #1a1c19;
            --surface: #f9faf4;
            --on-surface: #1a1c19;
            --surface-variant: #dee5d8;
            --on-surface-variant: #424940;
            --outline: #72796f;
            --outline-variant: #c2c9bd;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #2f312d;
            --inverse-on-surface: #f0f1eb;
            --inverse-primary: #78dc77;
            --surface-dim: #dadad4;
            --surface-bright: #f9faf4;
            --surface-container-lowest: #ffffff;
            --surface-container-low: #f3f4ee;
            --surface-container: #eeeee8;
            --surface-container-high: #e8e9e2;
            --surface-container-highest: #e2e3dd;
        }

        body.dark {
            --primary: #78dc77;
            --on-primary: #00390a;
            --primary-container: #005313;
            --on-primary-container: #94f990;
            --secondary: #baccb3;
            --on-secondary: #253423;
            --secondary-container: #3b4b38;
            --on-secondary-container: #d5e8cf;
            --tertiary: #a0cfd4;
            --on-tertiary: #00363b;
            --tertiary-container: #1f4d52;
            --on-tertiary-container: #bcebf0;
            --error: #ffb4ab;
            --on-error: #690005;
            --error-container: #93000a;
            --on-error-container: #ffb4ab;
            --background: #1a1c19;
            --on-background: #e2e3dd;
            --surface: #121411;
            --on-surface: #e2e3dd;
            --surface-variant: #424940;
            --on-surface-variant: #c2c9bd;
            --outline: #8c9388;
            --outline-variant: #424940;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #e2e3dd;
            --inverse-on-surface: #2f312d;
            --inverse-primary: #006e1c;
            --surface-dim: #121411;
            --surface-bright: #383a36;
            --surface-container-lowest: #0c0f0c;
            --surface-container-low: #1a1c19;
            --surface-container: #1e201d;
            --surface-container-high: #282b27;
            --surface-container-highest: #333531;
        }

        .row.wrap {
            flex-wrap: wrap;
        }

        .pointer {
            cursor: pointer;
        }

        [v-cloak] {
            display: none;
        }

        dialog:is(.active, [open]) {
            z-index: 999999;
        }

        .text-wrap {
            white-space: break-spaces;
        }

        /* Canvas firma */
        canvas {
            width: 100%;
            height: 250px;
            border-radius: .25rem;
            cursor: crosshair;
        }

        /* Overlay dialog */
        .overlay.blur.active {
            backdrop-filter: blur(4px);
            z-index: 9998;
            position: fixed;
            inset: 0;
        }

        .fade-slide-enter-active,
        .fade-slide-leave-active {
            transition: all 0.3s ease;
        }

        .fade-slide-enter-from {
            opacity: 0;
            transform: translateX(30px);
        }

        .fade-slide-enter-to {
            opacity: 1;
            transform: translateX(0);
        }

        .fade-slide-leave-from {
            opacity: 1;
            transform: translateX(0);
        }

        .fade-slide-leave-to {
            opacity: 0;
            transform: translateX(-30px);
        }


        html,
        body {
            height: 100%;
            margin: 0;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* HEADER */
        header.fixed {
            flex: 0 0 auto;
        }

        /* MAIN */
        main.responsive {
            flex: 1 1 auto;
            overflow-y: auto;
        }

        /* FOOTER */
        footer.fixed {
            position: fixed !important;
            bottom: 0;
            top: auto !important;
        }
    </style>

    <style>
        /* bounceIn semplice */
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        /* bounceOut semplice */
        @keyframes bounceOut {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            20% {
                transform: scale(0.9);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* Classe animazione */
        .animate-bounceIn {
            animation: bounceIn 0.7s both;
            /* durata e mantenimento finale */
        }

        .animate-bounceOut {
            animation: bounceOut 0.5s both;
        }

        /* Delay a cascata */
        nav.large-elevate>*:nth-child(1) {
            animation-delay: 0s;
        }

        nav.large-elevate>*:nth-child(2) {
            animation-delay: 0.1s;
        }

        nav.large-elevate>*:nth-child(3) {
            animation-delay: 0.2s;
        }

        nav.large-elevate>*:nth-child(4) {
            animation-delay: 0.3s;
        }

        nav.large-elevate>*:nth-child(5) {
            animation-delay: 0.4s;
        }

        nav.large-elevate>*:nth-child(6) {
            animation-delay: 0.5s;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>

        <!-- HEADER -->
        <header class="fixed" style="box-shadow: var(--elevate1);">
            <nav>
                <button class="circle transparent" @click="goBack"
                    v-if="currentSection !== 'home'"><i>arrow_back</i></button>
                <div class="shape loading-indicator tiny" v-if="loading"></div>
                <h6 class="max">{{ title }}</h6>
                <button class="circle transparent" @click="toggleTheme"><i>{{ isDark ? 'light_mode' : 'dark_mode'
                        }}</i></button>
                <button class="circle transparent" @click="openDialog"><i>settings</i></button>
            </nav>
        </header>

        <transition name="fade-slide" mode="out-in">
            <main class="responsive" :key="currentSection">


                <!-- 🏠 HOME -->
                <section v-if="currentSection === 'home'">
                    <h3>Verifiche Ispettiva</h3>

                    <!-- Ricerca e tab -->
                    <div class="grid">
                        <div class="s12 m12 l4">
                            <div class="row">
                                <div class="field prefix round fill active max">
                                    <i class="front">search</i>
                                    <input v-model="searchQuery" placeholder="Cerca cantieri...">
                                </div>
                            </div>
                        </div>
                        <div class="l l2"></div>
                        <div class="s12 m12 l6">
                            <div class="row wrap right-align">
                                <nav class="l tabbed small"> <!--style="block-size: 2.1rem;"-->
                                    <a v-for="tab in tabs" :key="tab.id" :class="{ active: activeTab === tab.id }"
                                        @click="activeTab = tab.id">
                                        <i>{{ tab.icon }}</i>
                                        <small>{{ tab.label }}</small>
                                    </a>
                                </nav>
                                <nav class="s m tabbed small" style="block-size: 2rem;"> 
                                    <a v-for="tab in tabs" :key="tab.id" :class="{ active: activeTab === tab.id }"
                                        @click="activeTab = tab.id">
                                        <i>{{ tab.icon }}</i>
                                        <small>{{ tab.label }}</small>
                                    </a>
                                </nav>
                                <label class="switch icon">
                                    <input type="checkbox" v-model="showArchived">
                                    <span>
                                        <i>archive</i>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Lista cantieri -->
                    <div class="grid">
                        <article class=" s12 m6 l4 padding border"
                            :class="{ 'tertiary-border': c.archived, 'error-border': (worksiteHasNC(c) && !c.archived), 'primary-border': (c.progress >= 100) }"
                            v-for="c in filteredWorksites" :key="c.id">
                            <div class="row">
                                <i class="extra">{{c.icon || "handyman"}}</i>
                                <div class="max">
                                    <h5>{{ c.nome }}</h5>
                                    <p class="no-margin">{{ c.descr }}</p>
                                </div>
                            </div>
                            <div class="row">
                                <label>{{ c.progress < 100 ? 'Incompleto' : 'Completato' }}</label>
                                        <progress :value="c.progress" max="100"></progress>
                                        <label>{{ c.progress }}%</label>
                            </div>
                            <nav>
                                <button @click="openWorksite(c)">Apri</button>
                                <div class="max"></div>
                                <nav>
                                    <button class="circle transparent" disabled>
                                        <i>share</i>
                                        <div class="badge border secondary-border secondary-text">dev</div>
                                    </button>

                                    <button class="circle transparent" @click="toggleArchive(c)">
                                        <i>{{ c?.archived ? 'restore' : 'archive' }}</i>
                                        <div class="tooltip max">
                                            <b>Title</b>
                                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                                tempor incididunt ut labore et dolore magna aliqua.</p>
                                            <nav>
                                                <a class="inverse-link">Action</a>
                                            </nav>
                                        </div>
                                    </button>

                                    <button class="circle transparent" @click="downloadWorksite(c)">
                                        <i>download</i>
                                        <div class="badge no-round primary">New</div>
                                    </button>

                                    <button class="circle transparent" @click="deleteWorksite(c)">
                                        <i>delete</i>
                                    </button>
                                </nav>
                            </nav>
                        </article>
                    </div>
                    <div class="center-align">
                        <em class="secondary-text" v-if="filteredWorksites.length === 0">Non ci sono cantieri da
                            visualizzare...
                            (-.-)</em>
                    </div>


                </section>

                <!-- 🏗️ WORKSITE -->
                <section v-else-if="currentSection === 'worksite'" style="margin-bottom: 5rem;">
                    <header>
                        <h5 class="m-none">Dettagli Cantiere</h5>
                    </header>

                    <article class="padding">
                        <!-- Campi fissi -->
                        <fieldset>
                            <legend>Dati generali</legend>
                            <div class="field border label">
                                <input type="text" v-model="selectedWorksite.nome" @input="autoSaveWorksite" required>
                                <label>Nome cantiere</label>
                            </div>
                            <div class="field border label textarea">
                                <textarea rows="2" v-model="selectedWorksite.descr"
                                    @input="autoSaveWorksite"></textarea>
                                <label>Descrizione</label>
                            </div>
                            <div class="field border label">
                                <input type="date" v-model="selectedWorksite.data" @input="autoSaveWorksite">
                                <label>Data</label>
                            </div>
                        </fieldset>

                        <!-- Campi dinamici -->
                        <fieldset>
                            <legend>Dati luogo e impresa</legend>
                            <template v-for="(val, key) in selectedWorksite.worksite" :key="key">
                                <div v-if="typeof val === 'string'" class="field border label"
                                    :class="{ textarea: val.length > 60 }">
                                    <textarea v-if="val.length > 60" rows="3" v-model="selectedWorksite.worksite[key]"
                                        @input="autoSaveWorksite"></textarea>
                                    <input v-else type="text" v-model="selectedWorksite.worksite[key]"
                                        @input="autoSaveWorksite">
                                    <label>{{ formatLabel(key) }}</label>
                                </div>
                            </template>
                        </fieldset>

                        <div class="row wrap">
                            <span class="chip"><strong>ID:</strong> {{ selectedWorksite?.id }}</span>
                            <span class="chip"><strong>Version:</strong> {{selectedWorksite?.version}}</span>
                            <span class="chip"><strong>Prototype:</strong> {{selectedWorksite?.prototype}}</span>
                            <span class="chip"><strong>Type:</strong> {{selectedWorksite?.prototypeType}}</span>
                        </div>
                    </article>


                </section>

                <!-- ✅ CHECKLIST -->
                <transition name="fade-slide" mode="out-in">
                    <section v-if="currentSection === 'checklist' && selectedWorksite" style="margin-bottom: 5rem;"
                        :key="currentSectionIndex">
                        <header>
                            <div class="row">
                                <i>{{ currentChecklistSections[currentSectionIndex].icon }}</i>
                                <progress :value="checklistProgress" max="100"></progress>
                                <label>{{ checklistProgress }}%</label>
                            </div>
                            <h5>
                                {{ currentSectionIndex + 1 }} – {{ currentChecklistSections[currentSectionIndex].title
                                }}
                            </h5>
                        </header>

                        <article v-if="currentChecklistSections[currentSectionIndex].type === 'checklist'">
                            <ul class="list border">
                                <li v-for="(item, index) in currentChecklistSections[currentSectionIndex].items"
                                    :key="index">
                                    <div class="grid max">
                                        <div class="s12 m9 l10">
                                            <div class="row">
                                                <i class="m l">{{ item.icon }}</i>
                                                <h6 class="max small text-wrap">{{ item.text }}</h6>
                                            </div>
                                        </div>

                                        <div class="row s12 m3 l2 right-align">
                                            <div class="center-align" v-for="val in ['C','N.C.','N.A.']" :key="val">
                                                <h6 class="small">{{ val }}</h6>
                                                <label class="radio icon">
                                                    <input type="radio"
                                                        :name="'radio_' + currentSectionIndex + '_' + index"
                                                        v-model="item.value" :value="val"
                                                        @change="updateChecklistItem(currentChecklistSections[currentSectionIndex], item, $event)">
                                                    <span>
                                                        <i>circle</i>
                                                        <i v-if="val==='C'" class="primary">check_circle</i>
                                                        <i v-else-if="val==='N.C.'" class="error">error</i>
                                                        <i v-else>do_not_disturb_on</i>
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>

                            <!-- Note della sezione -->
                            <div class="field textarea label border round extra">
                                <textarea v-model="currentChecklistSections[currentSectionIndex].notes"
                                    @input="updateSection(currentChecklistSections[currentSectionIndex])"></textarea>
                                <label>Note:</label>
                            </div>

                            <!-- Foto allegati -->
                            <div class="grid">
                                <article class="s12 m4 l4 no-padding border"
                                    v-for="(att, idx) in currentChecklistSections[currentSectionIndex].attachments || []"
                                    :key="att.id">
                                    <img class="responsive medium pointer" :src="att.data"
                                        @click="openAttachment(att)" />
                                    <div class="absolute bottom left right padding bottom-shadow white-text">
                                        <nav>
                                            <small>{{ att.name_ || 'Foto' }}</small>
                                            <div class="max"></div>
                                            <button class="circle transparent" @click="downloadAttachment(att)">
                                                <i>download</i>
                                                <div class="badge no-round primary">New</div>
                                            </button>
                                            <button class="circle transparent" @click.stop="removeAttachment(idx)">
                                                <i>delete</i>
                                            </button>
                                        </nav>
                                    </div>
                                </article>
                            </div>
                        </article>

                        <article v-if="currentChecklistSections[currentSectionIndex].type === 'signature'">
                            <h6>Firme</h6>

                            <div class="grid">
                                <article class="s12 m4 l4 no-padding border"
                                    v-for="(sig, idx) in currentChecklistSections[currentSectionIndex].signatures"
                                    :key="idx">
                                    <img v-if="sig.signature" :src="sig.signature" class="responsive medium" />
                                    <img v-else
                                        src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22></svg>"
                                        class="responsive medium" />
                                    <div class="absolute bottom left right padding bottom-shadow white-text">
                                        <nav>
                                            <div>
                                                <h5>{{ sig.name }}</h5>
                                                <small>{{ sig.role }}</small>
                                            </div>
                                            <div class="max"></div>
                                            <button class="circle transparent" @click="openSigDlg(sig, idx)">
                                                <i>signature</i>
                                            </button>
                                        </nav>
                                    </div>
                                </article>
                            </div>
                        </article>

                        <article v-if="currentChecklistSections[currentSectionIndex].type === 'note'">
                            <!-- Note della sezione -->
                            <div class="field textarea label border round extra">
                                <textarea v-model="currentChecklistSections[currentSectionIndex].notes"
                                    @input="updateSection(currentChecklistSections[currentSectionIndex])"></textarea>
                                <label>Note:</label>
                            </div>
                            <!-- Foto allegati -->
                            <div class="grid">
                                <article class="s12 m4 l4 no-padding border"
                                    v-for="(att, idx) in currentChecklistSections[currentSectionIndex].attachments || []"
                                    :key="att.id">
                                    <img class="responsive medium pointer" :src="att.data"
                                        @click="openAttachment(att)" />
                                    <div class="absolute bottom left right padding bottom-shadow white-text">
                                        <nav>
                                            <small>{{ att.name_ || 'Foto' }}</small>
                                            <div class="max"></div>
                                            <button class="circle transparent" @click="downloadAttachment(att)">
                                                <i>download</i>
                                                <div class="badge no-round primary">New</div>
                                            </button>
                                            <button class="circle transparent" @click.stop="removeAttachment(idx)">
                                                <i>delete</i>
                                            </button>
                                        </nav>
                                    </div>
                                </article>
                            </div>
                        </article>

                        <article v-if="currentChecklistSections[currentSectionIndex].type === 'table'">
                            <div class="row scroll">
                                <table class="bordered">
                                    <thead>
                                        <tr>
                                            <th v-for="(col, cIndex) in currentChecklistSections[currentSectionIndex].items[0].columns"
                                                :key="cIndex">
                                                {{ col.name }}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(row, rIndex) in currentChecklistSections[currentSectionIndex].items[0].rows"
                                            :key="rIndex">
                                            <td v-for="(col, cIndex) in currentChecklistSections[currentSectionIndex].items[0].columns"
                                                :key="cIndex">

                                                <!-- se tipo text, input -->
                                                <div class="field border label" v-if="col.type === 'text'">
                                                    <input type="text" v-model="row[col.name]"
                                                        @input="updateTableItem(currentChecklistSections[currentSectionIndex], row, col.name, $event.target.value)" />
                                                    <label>Text</label>
                                                </div>

                                                <!-- se tipo checkbox -->
                                                <label class="checkbox" v-else-if="col.type === 'checkbox'">
                                                    <input type="checkbox" v-model="row[col.name]"
                                                        @change="updateTableItem(currentChecklistSections[currentSectionIndex], row, col.name, row[col.name])">
                                                    <span></span>
                                                </label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <small>{{currentChecklistSections[currentSectionIndex].items[0].legend}}</small>

                            <!-- Note della sezione -->
                            <div class="field textarea label border round extra">
                                <textarea v-model="currentChecklistSections[currentSectionIndex].notes"
                                    @input="updateSection(currentChecklistSections[currentSectionIndex])"></textarea>
                                <label>Note:</label>
                            </div>

                            <!-- Foto allegati -->
                            <div class="grid">
                                <article class="s12 m4 l4 no-padding border"
                                    v-for="(att, idx) in currentChecklistSections[currentSectionIndex].attachments || []"
                                    :key="att.id">
                                    <img class="responsive medium pointer" :src="att.data"
                                        @click="openAttachment(att)" />
                                    <div class="absolute bottom left right padding bottom-shadow white-text">
                                        <nav>
                                            <small>{{ att.name_ || 'Foto' }}</small>
                                            <div class="max"></div>
                                            <button class="circle transparent" @click="downloadAttachment(att)">
                                                <i>download</i>
                                                <div class="badge no-round primary">New</div>
                                            </button>
                                            <button class="circle transparent" @click.stop="removeAttachment(idx)">
                                                <i>delete</i>
                                            </button>
                                        </nav>
                                    </div>
                                </article>
                            </div>
                        </article>




                    </section>
                </transition>


            </main>
        </transition>

        <!-- FOOTER GLOBALE -->
        <footer class="fixed transparent footer-transition"
            :class="currentSection === 'home' ? 'right-align' : 'center-align'">
            <nav class="large-elevate" :class="{'toolbar secondary-container': currentSection !== 'home'}">
                <!-- HOME -->
                <template v-if="currentSection === 'home'">
                    <button class="square round extra animate-bounceIn" @click="showDialogNewWorksite = true">
                        <i>add</i>
                    </button>
                </template>

                <!-- WORKSITE -->
                <template v-else-if="currentSection === 'worksite'">
                    <button class="circle transparent animate-bounceIn" @click="goBack">
                        <i>arrow_back</i>
                    </button>
                    <button class="circle transparent animate-bounceIn" @click="openChecklist"><i>checklist</i></button>
                    <button class="circle transparent animate-bounceIn" @click="downloadWorksite(selectedWorksite)">
                        <i>download</i>
                        <div class="badge no-round primary ">New</div>
                    </button>
                    <button class="circle transparent animate-bounceIn"
                        @click="goToSignatureSection()"><i>signature</i></button>
                </template>

                <!-- CHECKLIST -->
                <template v-else-if="currentSection === 'checklist' && selectedWorksite">
                    <button class="circle transparent animate-bounceIn" @click="goBack">
                        <i>arrow_back</i>
                    </button>

                    <button class="circle transparent animate-bounceIn" @click="prevSection"
                        :disabled="currentSectionIndex === 0">
                        <i>chevron_backward</i>
                    </button>

                    <span class="max center-align animate-bounceIn">
                        {{ currentSectionIndex + 1 }} / {{ currentChecklistSections.length }}
                    </span>

                    <button class="circle transparent animate-bounceIn" @click="nextSection"
                        :disabled="currentSectionIndex === currentChecklistSections.length - 1">
                        <i>chevron_forward</i>
                    </button>

                    <template v-if="currentChecklistSections[currentSectionIndex].attachments">
                        <button class="circle transparent animate-bounceIn">
                            <i>attach_file</i>
                            <input class="pointer" type="file" accept="image/*"
                                @change="e => handleFileChange(e, currentChecklistSections[currentSectionIndex])">
                        </button>
                        <button class="circle transparent animate-bounceIn">
                            <i>photo_camera</i>
                            <input class="pointer" type="file" accept="image/*" capture="environment"
                                @change="e => handleFileChange(e, currentChecklistSections[currentSectionIndex])">
                        </button>
                    </template>
                </template>
            </nav>
        </footer>



        <!-- DIALOG GENERICO -->
        <div class="overlay blur" :class="{ active: dialog.visible }"></div>
        <dialog :open="dialog.visible" class="max-w-sm round elevated">
            <h5>{{ dialog.title }}</h5>
            <div>{{ dialog.message }}</div>
            <nav class="right-align">
                <button class="transparent link" @click="cancelDialog()">Annulla</button>
                <button class="primary" @click="confirmDialog()">Conferma</button>
            </nav>
        </dialog>

        <!-- Signature dialog -->
        <div class="overlay" :class="{active: signatureState.open}" @click="closeSigDlg"></div>
        <dialog :class="{active: signatureState.open}" :open="signatureState.open" class="responsive">
            <header>
                <h5>Firma</h5>
            </header>
            <div>
                <div class="field border label">
                    <input v-model="signatureState.currentSig.name">
                    <label>Nome firmatario</label>
                </div>
                <canvas ref="signCanvas" class="sig-canvas signCanvas border"></canvas>
                <nav class="right-align">
                    <button class="transparent link" @click="sigClear">Pulisci</button>
                    <button class="transparent link" @click="sigSave">Salva firma</button>
                </nav>
            </div>
        </dialog>

        <!-- Dialog fullscreen per le foto -->
        <dialog :open="photoDialog" class="max">
            <img :src="dialogImage" class="responsive" style="max-height:90vh;">
            <nav class="right-align" style="margin-top:10px;">
                <button class="border" @click="photoDialog = false">Chiudi</button>
            </nav>
        </dialog>

        <!-- DIALOG NUOVO CANTIERE -->
        <div class="overlay blur" :class="{ active: showDialogNewWorksite }"></div>
        <dialog :open="showDialogNewWorksite" class="responsive">
            <h5>Nuovo Cantiere</h5>
            <form @submit.prevent="addCantiere">
                <div class="field label border"><input v-model="newCantiere.nome" required><label>Nome cantiere
                        *</label></div>
                <div class="field label border"><input v-model="newCantiere.descr"><label>Descrizione</label></div>
                <div class="field label border">
                    <select v-model="newCantiere.file" required>
                        <option disabled value="">Seleziona prototipo</option>
                        <option v-for="proto in prototypes" :key="proto.version" :value="proto.file">{{ proto.version }}
                            - {{ proto.nome }}</option>
                    </select>
                    <label>Prototipo cantiere</label>
                </div>
                <nav class="right-align no-space mt">
                    <button type="button" class="transparent link"
                        @click="showDialogNewWorksite = false">Chiudi</button>
                    <button type="submit" class="primary">Conferma</button>
                </nav>
            </form>
        </dialog>

        <!-- TOAST -->
        <div class="snackbar" :class="[toast.type, { active: toast.active }]">
            <div class="max">{{ toast.text }}</div>
            <a v-if="toast.action" class="inverse-link" @click="toast.action.callback">{{ toast.action.label }}</a>
        </div>

    </div>

    <script type="module" src="./js/app.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</body>

</html>