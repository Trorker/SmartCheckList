<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196f3">

    <title>Check List Cantieri - Levratti</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚧</text></svg>">

    <!-- BeerCSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.js"></script>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Dexie.js -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
        /* Tema personalizzato chiaro e scuro */
        :root {
            --primary: #006e1c;
            --on-primary: #ffffff;
            --primary-container: #94f990;
            --on-primary-container: #002204;
            --secondary: #52634f;
            --on-secondary: #ffffff;
            --secondary-container: #d5e8cf;
            --on-secondary-container: #111f0f;
            --tertiary: #38656a;
            --on-tertiary: #ffffff;
            --tertiary-container: #bcebf0;
            --on-tertiary-container: #002023;
            --error: #ba1a1a;
            --on-error: #ffffff;
            --error-container: #ffdad6;
            --on-error-container: #410002;
            --background: #fcfdf6;
            --on-background: #1a1c19;
            --surface: #f9faf4;
            --on-surface: #1a1c19;
            --surface-variant: #dee5d8;
            --on-surface-variant: #424940;
            --outline: #72796f;
            --outline-variant: #c2c9bd;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #2f312d;
            --inverse-on-surface: #f0f1eb;
            --inverse-primary: #78dc77;
            --surface-dim: #dadad4;
            --surface-bright: #f9faf4;
            --surface-container-lowest: #ffffff;
            --surface-container-low: #f3f4ee;
            --surface-container: #eeeee8;
            --surface-container-high: #e8e9e2;
            --surface-container-highest: #e2e3dd;
        }

        body.dark {
            --primary: #78dc77;
            --on-primary: #00390a;
            --primary-container: #005313;
            --on-primary-container: #94f990;
            --secondary: #baccb3;
            --on-secondary: #253423;
            --secondary-container: #3b4b38;
            --on-secondary-container: #d5e8cf;
            --tertiary: #a0cfd4;
            --on-tertiary: #00363b;
            --tertiary-container: #1f4d52;
            --on-tertiary-container: #bcebf0;
            --error: #ffb4ab;
            --on-error: #690005;
            --error-container: #93000a;
            --on-error-container: #ffb4ab;
            --background: #1a1c19;
            --on-background: #e2e3dd;
            --surface: #121411;
            --on-surface: #e2e3dd;
            --surface-variant: #424940;
            --on-surface-variant: #c2c9bd;
            --outline: #8c9388;
            --outline-variant: #424940;
            --shadow: #000000;
            --scrim: #000000;
            --inverse-surface: #e2e3dd;
            --inverse-on-surface: #2f312d;
            --inverse-primary: #006e1c;
            --surface-dim: #121411;
            --surface-bright: #383a36;
            --surface-container-lowest: #0c0f0c;
            --surface-container-low: #1a1c19;
            --surface-container: #1e201d;
            --surface-container-high: #282b27;
            --surface-container-highest: #333531;
        }

        .pointer {
            cursor: pointer;
        }

        [v-cloak] {
            display: none;
        }

        dialog:is(.active, [open]) {
            z-index: 999999;
        }

        .text-wrap {
            white-space: break-spaces;
        }

        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 0.25s ease;
        }

        .slide-fade-enter-from {
            opacity: 0;
            transform: translateX(10px);
        }

        .slide-fade-leave-to {
            opacity: 0;
            transform: translateX(-10px);
        }

        /* Canvas firma */
        canvas {
            width: 100%;
            height: 150px;
            border: 1px solid var(--outline);
        }

        /* Overlay dialog */
        .overlay.blur.active {
            backdrop-filter: blur(4px);
            z-index: 9998;
            position: fixed;
            inset: 0;
        }

        /* Footer fisso per pulsanti */
        footer.fixed-toolbar {
            position: fixed;
            inset: auto 0 var(--_padding) 0;
            z-index: 9999;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>

        <!-- HEADER -->
        <header class="fixed" style="box-shadow: var(--elevate1);">
            <nav>
                <button class="circle transparent" @click="goBack"
                    v-if="currentSection !== 'home'"><i>arrow_back</i></button>
                <div class="shape loading-indicator tiny" v-if="loading"></div>
                <h6 class="max">{{ title }}</h6>
                <button class="circle transparent" @click="toggleTheme"><i>{{ isDark ? 'light_mode' : 'dark_mode'
                        }}</i></button>
                <button class="circle transparent" @click="openDialog"><i>settings</i></button>
            </nav>
        </header>

        <main class="responsive">

            <!-- 🏠 HOME -->
            <section v-if="currentSection === 'home'">
                <h3>Verifiche Ispettiva</h3>

                <!-- Ricerca e tab -->
                <div class="grid">
                    <div class="s12 m12 l4">
                        <div class="row">
                            <div class="field prefix round fill active max">
                                <i class="front">search</i>
                                <input placeholder="Cerca cantiere">
                            </div>
                        </div>
                    </div>
                    <div class="l l2"></div>
                    <div class="s12 m12 l6">
                        <div class="row right-align">
                            <nav class="tabbed small">
                                <a v-for="tab in tabs" :key="tab.id" :class="{ active: activeTab === tab.id }"
                                    @click="activeTab = tab.id">
                                    <i>{{ tab.icon }}</i>
                                    <span>{{ tab.label }}</span>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Lista cantieri -->
                <div class="grid">
                    <div class="s12 m6 l4" v-for="c in worksites" :key="c.id">
                        <article class="no-padding">
                            <img class="responsive"
                                src="https://www.impresalevratti.it/wp-content/uploads/2021/12/20211123_092730.jpeg" />
                            <div class="padding">
                                <h5>{{ c.nome }}</h5>
                                <p>{{ c.descr }}</p>
                                <div class="row">
                                    <label>{{ c.progress < 100 ? 'Incompleto' : 'Completato' }}</label>
                                            <progress :value="c.progress" max="100"></progress>
                                            <label>{{ c.progress }}%</label>
                                </div>
                                <nav>
                                    <button @click="openWorksite(c)">Apri</button>
                                    <div class="max"></div>
                                    <nav>
                                        <button class="circle transparent"><i>share</i></button>
                                        <button class="circle transparent"><i>download</i>
                                            <div class="badge no-round">New</div>
                                        </button>
                                        <button class="circle transparent"
                                            @click="addToast('Cantiere eliminato', 'error', {label:'Annulla', callback:()=>addToast('Annullato', 'primary')})">
                                            <i>delete</i>
                                        </button>
                                    </nav>
                                </nav>
                            </div>
                        </article>
                    </div>
                </div>

                <footer class="fixed-toolbar right-align">
                    <nav>
                        <button class="square round extra" @click="showDialogNewWorksite = true"><i>add</i></button>
                    </nav>
                </footer>
            </section>

            <!-- 🏗️ WORKSITE -->
            <section v-else-if="currentSection === 'worksite'">
                <header>
                    <h5 class="m-none">Dettagli Cantiere</h5>
                </header>
                <article class="padding">
                    <form @submit.prevent="saveWorksite()">
                        <fieldset>
                            <legend>Dati generali</legend>
                            <div class="field border label">
                                <input type="text" v-model="selectedWorksite.nome" required>
                                <label>Nome cantiere</label>
                            </div>
                            <div class="field border label textarea">
                                <textarea rows="2" v-model="selectedWorksite.descr"></textarea>
                                <label>Descrizione</label>
                            </div>
                            <div class="field border label">
                                <input type="date" v-model="selectedWorksite.data">
                                <label>Data</label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Dati luogo e impresa</legend>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.contratto"><label>Contratto / LCL / Lavoro</label>
                            </div>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.comune"><label>Comune</label></div>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.provincia"><label>Provincia</label></div>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.indirizzo"><label>Indirizzo</label></div>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.impresa"><label>Impresa esecutrice</label></div>
                            <div class="field border label textarea"><textarea rows="3"
                                    v-model="selectedWorksite.luogo.attivita"></textarea><label>Attività svolta</label>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Verificatore</legend>
                            <div class="field border label"><input type="text"
                                    v-model="selectedWorksite.luogo.verificatore"><label>Verificatore</label></div>
                        </fieldset>
                    </form>
                    <span class="chip small margin center">ID: {{ selectedWorksite?.id }}</span>
                </article>

                <footer class="fixed-toolbar center-align">
                    <nav class="toolbar secondary-container large-elevate">
                        <button class="circle transparent" @click="goBack"><i>arrow_back</i></button>
                        <button class="circle transparent" @click="openChecklist"><i>checklist</i></button>
                        <button class="circle transparent"><i>attach_file</i><input type="file"></button>
                        <button class="circle transparent" @click="openDialog"><i>signature</i></button>
                    </nav>
                </footer>
            </section>

            <!-- ✅ CHECKLIST -->
            <section v-if="currentSection === 'checklist' && selectedWorksite">
                <div class="padding">
                    <h5>
                        {{ currentSectionIndex + 1 }} – {{ currentChecklistSections[currentSectionIndex].title }}
                    </h5>

                    <article v-if="currentChecklistSections[currentSectionIndex].type === 'checklist'">
                        <ul class="list border">
                            <li v-for="(item, index) in currentChecklistSections[currentSectionIndex].items"
                                :key="index">
                                <div class="grid max">
                                    <div class="s12 m9 l10">
                                        <div class="row">
                                            <i class="m l">{{ item.icon }}</i>
                                            <h6 class="max small text-wrap">{{ item.text }}</h6>
                                        </div>
                                    </div>

                                    <div class="row s12 m3 l2 right-align">
                                        <div class="center-align" v-for="val in ['C','N.C.','N.A.']" :key="val">
                                            <h6 class="small">{{ val }}</h6>
                                            <label class="radio icon">
                                                <input type="radio" :name="'radio_' + currentSectionIndex + '_' + index"
                                                    v-model="item.value" :value="val"
                                                    @change="updateChecklistItem(currentChecklistSections[currentSectionIndex], item)">
                                                <span>
                                                    <i>circle</i>
                                                    <i v-if="val==='C'" class="primary">check_circle</i>
                                                    <i v-else-if="val==='N.C.'" class="error">error</i>
                                                    <i v-else>do_not_disturb_on</i>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>

                        <!-- Note della sezione -->
                        <div class="field textarea label border round extra">
                            <textarea v-model="currentChecklistSections[currentSectionIndex].notes"
                                @input="updateSection(currentChecklistSections[currentSectionIndex])"></textarea>
                            <label>Note:</label>
                        </div>

                        <!-- Foto allegati -->
                        <div class="grid">
                            <article class="s12 m4 l4 no-padding border"
                                v-for="(att, idx) in currentChecklistSections[currentSectionIndex].attachments || []"
                                :key="att.id">
                                <img class="responsive medium pointer" :src="att.data" @click="openAttachment(att)" />
                                <div class="absolute bottom left right padding bottom-shadow white-text">
                                    <nav>
                                        <small>{{ att.name_ || 'Foto' }}</small>
                                        <div class="max"></div>
                                        <button class="circle transparent" @click.stop="removeAttachment(idx)">
                                            <i>delete</i>
                                        </button>
                                    </nav>
                                </div>
                            </article>
                        </div>
                    </article>

                    <!-- Footer navigazione + aggiungi foto -->
                    <footer class="fixed-toolbar center-align">
                        <nav class="toolbar secondary-container large-elevate">
                            <button class="circle transparent" @click="prevSection"
                                :disabled="currentSectionIndex === 0">
                                <i>arrow_back</i>
                            </button>

                            <span class="max center-align">
                                {{ currentSectionIndex + 1 }} / {{ currentChecklistSections.length }}
                            </span>

                            <button class="circle transparent" @click="nextSection"
                                :disabled="currentSectionIndex === currentChecklistSections.length - 1">
                                <i>arrow_forward</i>
                            </button>

                            <button class="circle transparent">
                                <i>attach_file</i>
                                <input type="file" accept="image/*"
                                    @change="e => handleFileChange(e, currentChecklistSections[currentSectionIndex])">
                            </button>

                            <button class="circle transparent">
                                <i>photo_camera</i>
                                <input type="file" accept="image/*" capture="environment"
                                    @change="e => handleFileChange(e, currentChecklistSections[currentSectionIndex])">
                            </button>
                        </nav>
                    </footer>
                </div>
            </section>



        </main>

        <!-- DIALOG GENERICO -->
        <div class="overlay blur" :class="{ active: showDialog }"></div>
        <dialog :open="showDialog">
            <h5>Informazioni</h5>
            <div>Questa è una finestra modale gestita con Vue + BeerCSS.</div>
            <nav class="right-align no-space mt">
                <button class="transparent link" @click="closeDialog">Chiudi</button>
                <button class="transparent link" @click="confirmAction">Conferma</button>
            </nav>
        </dialog>

        <!-- Dialog fullscreen per le foto -->
        <dialog :open="photoDialog" class="max">
            <img :src="dialogImage" class="responsive" style="max-height:90vh;">
            <nav class="right-align" style="margin-top:10px;">
                <button class="border" @click="photoDialog = false">Chiudi</button>
            </nav>
        </dialog>

        <!-- DIALOG NUOVO CANTIERE -->
        <div class="overlay blur" :class="{ active: showDialogNewWorksite }"></div>
        <dialog :open="showDialogNewWorksite" class="responsive">
            <h5>Nuovo Cantiere</h5>
            <form @submit.prevent="addCantiere">
                <div class="field label border"><input v-model="newCantiere.nome" required><label>Nome cantiere
                        *</label></div>
                <div class="field label border"><input v-model="newCantiere.descr"><label>Descrizione</label></div>
                <div class="field label border">
                    <select v-model="newCantiere.file" required>
                        <option disabled value="">Seleziona prototipo</option>
                        <option v-for="proto in prototypes" :key="proto.version" :value="proto.file">{{ proto.version }}
                            - {{ proto.nome }}</option>
                    </select>
                    <label>Prototipo cantiere</label>
                </div>
                <nav class="right-align no-space mt">
                    <button type="button" class="transparent link"
                        @click="showDialogNewWorksite = false">Chiudi</button>
                    <button type="submit" class="primary">Conferma</button>
                </nav>
            </form>
        </dialog>

        <!-- TOAST -->
        <div class="snackbar" :class="[toast.type, { active: toast.active }]">
            <div class="max">{{ toast.text }}</div>
            <a v-if="toast.action" class="inverse-link" @click="toast.action.callback">{{ toast.action.label }}</a>
        </div>

    </div>

    <script type="module" src="./js/app.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</body>

</html>